<div class="registro-sensor-container">
  <mat-card class="register-card">
    <button mat-icon-button (click)="onExit()" class="back-button" matTooltip="Volver">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <mat-card-header class="card-header">
      <mat-card-title class="card-title">REGISTRO DE SENSOR: {{ sensorData?.NombreTipoSensor | uppercase }}</mat-card-title>
      <mat-card-subtitle class="card-subtitle">Complete los detalles para registrar su nuevo sensor.</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="card-content">
      <form [formGroup]="sensorForm" (ngSubmit)="onSubmit()" class="sensor-form">

        <mat-divider class="section-divider"></mat-divider>
        <h3 class="section-title">Información General</h3>
        <div class="form-section">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre del Sensor</mat-label>
            <input matInput
              placeholder="Ej. Sensor Temp Invernadero 1"
              formControlName="nombre">
            <mat-error *ngIf="sensorForm.get('nombre')?.invalid && (sensorForm.get('nombre')?.dirty || sensorForm.get('nombre')?.touched)">
              El nombre es requerido.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Cultivo Asociado</mat-label>
            <mat-select formControlName="cultivo" (selectionChange)="onCultivoChange($event)">
              <mat-option *ngFor="let cultivo of cultivos" [value]="cultivo">
                {{ cultivo }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="sensorForm.get('cultivo')?.invalid && (sensorForm.get('cultivo')?.dirty || sensorForm.get('cultivo')?.touched)">
              El cultivo es requerido.
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Fecha de Instalación</mat-label>
            <input matInput
              [matDatepicker]="picker"
              formControlName="fecha"
              placeholder="Seleccione la fecha">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="sensorForm.get('fecha')?.invalid && (sensorForm.get('fecha')?.dirty || sensorForm.get('fecha')?.touched)">
              La fecha de instalación es requerida.
            </mat-error>
          </mat-form-field>
        </div>

        <mat-divider class="section-divider"></mat-divider>
        <h3 class="section-title">Ubicación del Sensor</h3>
        <div class="form-section map-section">
          <p class="map-description">Seleccione la ubicación exacta del sensor haciendo clic en el mapa del área de cultivo. El punto seleccionado aparecerá en el campo de ubicación.</p>

          <div class="cultivation-area-map-container">
            <div class="map-overlay-info">
                <h4>Área de Cultivo: {{ cultivationArea.nombre }}</h4>
                <p>Ubicación: {{ cultivationArea.ubicacion }}</p>
                <p>Tamaño: {{ cultivationArea.tamano }} ha</p>
            </div>
            <app-ver-mapa
              [coordenadas]="cultivationArea.coordenadas"
              [nombreParcela]="cultivationArea.nombre"
              [tamanoParcela]="cultivationArea.tamano"
              [mostrarDetalles]="true">
            </app-ver-mapa>
          </div>

          <div class="sensor-location-map-container">
            <p class="map-instruction">Haga clic en el mapa para seleccionar la ubicación del sensor:</p>
            <app-maps-sensor (onGeolocalizacionChange)="onMapGeolocalizacionChange($event)"></app-maps-sensor>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Coordenadas del Sensor</mat-label>
            <input matInput
              placeholder="Latitud, Longitud"
              formControlName="ubicacion"
              readonly>
            <mat-icon matSuffix>location_on</mat-icon>
            <mat-error *ngIf="sensorForm.get('ubicacion')?.invalid && (sensorForm.get('ubicacion')?.dirty || sensorForm.get('ubicacion')?.touched)">
              La ubicación del sensor es requerida (seleccione en el mapa).
            </mat-error>
          </mat-form-field>
        </div>

        <div class="button-container">
          <button mat-raised-button
            color="primary"
            type="submit"
            [disabled]="sensorForm.invalid || latitud === null || longitud === null"
            class="register-button">
            Registrar Sensor
          </button>
          <button mat-raised-button color="warn" (click)="onExit()" type="button" class="cancel-button">Cancelar</button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
