<div class="main-container">
  <h2 class="page-title" (click)="onExit()">
    Gestión de Alertas
    <mat-icon>notifications</mat-icon>
  </h2>

  <div *ngIf="loading" class="loading-indicator">
    <mat-progress-spinner diameter="50"></mat-progress-spinner>
    <p>Cargando alertas...</p>
  </div>

  <div *ngIf="error" class="error-message">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ errorMessage }}</p>
  </div>

  <div *ngIf="!loading && !error" class="content-wrapper">
    <div class="left-section table-view">
      <mat-card class="alert-table-card">
        <mat-card-content>
          <table mat-table [dataSource]="dataSource" matSort class="alert-table">
            <ng-container matColumnDef="nombreAlerta">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
              <td mat-cell *matCellDef="let alerta">{{ alerta.nombreAlerta }}</td>
            </ng-container>

            <ng-container matColumnDef="tipoAlerta">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
              <td mat-cell *matCellDef="let alerta">{{ alerta.tipoAlerta }}</td>
            </ng-container>

            <ng-container matColumnDef="prioridad">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Prioridad</th>
              <td mat-cell *matCellDef="let alerta">{{ alerta.prioridad }}</td>
            </ng-container>

            <ng-container matColumnDef="estado">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
              <td mat-cell *matCellDef="let alerta">{{ alerta.estado }}</td>
            </ng-container>

            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let alerta">
                <div class="action-buttons">
                  <button mat-icon-button matTooltip="Ver Detalles" color="primary" (click)="verAlerta(alerta)">
                    <mat-icon>visibility</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
          <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="left-section card-view">
      <div class="alert-cards-list">
        <mat-card *ngFor="let alerta of dataSource.filteredData" class="alert-item-card" (click)="verAlerta(alerta)">
          <mat-card-header>
            <mat-card-title>{{ alerta.nombreAlerta }}</mat-card-title>
            <mat-card-subtitle>{{ alerta.tipoAlerta }} | {{ alerta.prioridad }}</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="card-simple-detail">
              <mat-icon>info</mat-icon>
              <span>Estado: <span [ngClass]="{'estado-activa': alerta.estado === 'Activa', 'estado-inactiva': alerta.estado === 'Inactiva', 'estado-resuelta': alerta.estado === 'Resuelta'}">{{ alerta.estado }}</span></span>
            </div>
            <div class="card-simple-detail">
              <mat-icon>grass</mat-icon>
              <span>Cultivo: {{ alerta.nombreCultivo }}</span>
            </div>
          </mat-card-content>
          <mat-card-actions class="card-actions-simple">
            <button mat-button color="primary">Ver Más</button>
          </mat-card-actions>
        </mat-card>
      </div>
    </div>


    <div class="right-section" [@detailExpand]="alertaSeleccionada ? 'expanded' : 'collapsed'">
      <mat-card class="alert-details-card" *ngIf="alertaSeleccionada">
        <mat-card-header class="alert-details-header">
          <mat-card-title>{{ isEditing ? 'Editar Alerta' : 'Detalles de la Alerta' }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <form [formGroup]="alertaForm" class="form-container">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Nombre de la Alerta</mat-label>
              <input matInput formControlName="nombreAlerta" [readonly]="!isEditing">
              <mat-error *ngIf="alertaForm.get('nombreAlerta')?.hasError('required') && (alertaForm.get('nombreAlerta')?.dirty || alertaForm.get('nombreAlerta')?.touched)">
                El nombre es requerido.
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Descripción</mat-label>
              <textarea matInput formControlName="descripcion" [readonly]="!isEditing" rows="3"></textarea>
              <mat-error *ngIf="alertaForm.get('descripcion')?.hasError('required') && (alertaForm.get('descripcion')?.dirty || alertaForm.get('descripcion')?.touched)">
                La descripción es requerida.
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Tipo de Alerta</mat-label>
              <mat-select formControlName="tipoAlerta" [disabled]="!isEditing">
                <mat-option *ngFor="let tipo of tipoAlertaOptions" [value]="tipo">
                  {{ tipo }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="alertaForm.get('tipoAlerta')?.hasError('required') && (alertaForm.get('tipoAlerta')?.dirty || alertaForm.get('tipoAlerta')?.touched)">
                El tipo de alerta es requerido.
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Prioridad</mat-label>
              <mat-select formControlName="prioridad" [disabled]="!isEditing">
                <mat-option *ngFor="let prioridad of prioridadOptions" [value]="prioridad">
                  {{ prioridad }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="alertaForm.get('prioridad')?.hasError('required') && (alertaForm.get('prioridad')?.dirty || alertaForm.get('prioridad')?.touched)">
                La prioridad es requerida.
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Estado</mat-label>
              <mat-select formControlName="estado" [disabled]="!isEditing">
                <mat-option *ngFor="let estado of estadoOptions" [value]="estado">
                  {{ estado }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="alertaForm.get('estado')?.hasError('required') && (alertaForm.get('estado')?.dirty || alertaForm.get('estado')?.touched)">
                El estado es requerido.
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Nombre del Cultivo</mat-label>
              <input matInput formControlName="nombreCultivo" readonly>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Tipo de Sensor</mat-label>
              <input matInput formControlName="tipoSesnor" readonly>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Sensor Referenciado</mat-label>
              <input matInput formControlName="sensorReferenciado" readonly>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Ubicación</mat-label>
              <input matInput formControlName="ubicacion" readonly>
            </mat-form-field>

          </form>
        </mat-card-content>
        <mat-card-actions class="card-actions-detail">
          <button mat-raised-button color="primary" (click)="guardarAlerta()" [disabled]="!isEditing || alertaForm.invalid" *ngIf="isEditing">
            <mat-icon>save</mat-icon> Guardar Cambios
          </button>
          <button mat-button (click)="cancelarEdicion()" *ngIf="isEditing">
            <mat-icon>cancel</mat-icon> Cancelar
          </button>
          <button mat-raised-button color="primary" (click)="editarAlerta()" *ngIf="!isEditing && alertaSeleccionada.estado !== 'Resuelta'">
            <mat-icon>edit</mat-icon> Editar
          </button>
          <button mat-raised-button color="warn" (click)="eliminarAlerta(alertaSeleccionada)" *ngIf="!isEditing && alertaSeleccionada.estado !== 'Resuelta'">
            <mat-icon>delete</mat-icon> Eliminar
          </button>
          <button mat-raised-button color="accent" (click)="alertaSeleccionada = null; isEditing = false;" *ngIf="!isEditing && alertaSeleccionada">
            <mat-icon>close</mat-icon> Cerrar Detalles
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>
</div>